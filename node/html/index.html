<html>
  <head>
    <title>Conteo de votos Paralización de la #UTFSM Campus San Joaquín | CEEINF</title>
    <link rel="stylesheet" type="text/css" media="all" href="style.css" />
    <script src="jquery.min.js"></script>
    <script src="http://ec2-votaciones.csaldias.cl/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript">
      google.load('visualization', '1.0', {packages: ['corechart']});
    </script>
    <meta property="og:title" content="Conteo de votos Paralización de la #UTFSM Campus San Joaquín" /> 
    <meta property="og:image" content="" /> 
    <meta property="og:description" content="¡Sigue en directo, desde las 17:00 hrs del martes 9 de junio de 2015, el conteo de votos para la paralización de actividades en la UTFSM Campus San Joaquín!" /> 
    <meta property="og:url" content="http://votacion.feusam.cl/">
  </head>
  <body>
    <table id="conteo-table">
      <tr>
        <td>
          <table id="logo-info">
            <tr>
              <td id="logo">
                <p class="big">Votación<br />Paralización de Actividades<br />en la UTFSM<br />Campus San Joaquín</p>
              </td>
              <td id="info">
                <div class="message">
                  <div id="mensaje_texto"></div> <!-- ESTADO ACTUAL: Bla bla bla... -->
                </div>
                <div class="bar-body">
                  <div id="votos_1_barra" class="bar-inside" style="width:0%;background:red;"></div>
                </div>
                <div id="contando">
                  <div id="votos_1_texto">Conectando...</div> <!-- Quorum 30% (685/2153) -->
                </div>
                <div style="clear:both"></div>
                <div style="text-align:center">
                  <br/><b>Votación 1: Paro CONFECH Miércoles</b><br/><br/>
                </div>
                <!-- Inserte el gráfico acá. -->
                <div id="torta_1" style="text-align:center;width:400px;height:200px;"> 
                  <img id="torta_1_img" width="331" height="141"/>
                </div>

                <br />
                <table style="width:100%">
                  <tr>
                    <td style="width:1px;">
                      <img src="/graficos/graphref.php?ref=5&typ=1&dim=5&bkg=FFFFFF" width="11" height="11" /> <!-- Puntito color -->
                    </td>
                    <td style="">
                      <b>SI</b>
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="votos_1_si"></div> <!-- 781 voto(s) -->
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="porcentaje_1_si"></div> <!-- 88,75% -->
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <img src="/graficos/graphref.php?ref=11&typ=1&dim=5&bkg=FFFFFF" width="11" height="11" /> <!-- Puntito color -->
                    </td>
                    <td>
                      <b>NO</b>
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="votos_1_no"></div> <!-- 96 voto(s) -->
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="porcentaje_1_no"></div> <!-- 10,91% -->
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <img src="/graficos/graphref.php?ref=20&typ=1&dim=5&bkg=FFFFFF" width="11" height="11" /> <!-- Puntito color -->
                    </td>
                    <td>
                      <b>Blancos</b>
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="votos_1_blanco"></div> <!-- 0 voto(s) -->
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="porcentaje_1_blanco"></div> <!-- 0,00% -->
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <!-- Puntito color -->
                      <img src="/graficos/graphref.php?ref=8&typ=1&dim=5&bkg=FFFFFF" width="11" height="11" />
                    </td>
                    <td>
                      <b>Nulos</b>
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="votos_1_nulo"></div> <!-- 3 voto(s) -->
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="porcentaje_1_nulo"></div> <!-- 0,34% -->
                    </td>
                  </tr>
                </table>
              </td>
              <td id="info">
                <div style="height:45px"></div>
                <header>CONTEO DE VOTOS</header>
                <div class="bar-body">
                  <div id="votos_2_barra" class="bar-inside" style="width:0%;background:red;"></div>
                </div>
                <div id="contando">
                  <div id="votos_2_texto">Conectando...</div> <!-- Quorum 30% (685/2153) -->
                </div>
                <div style="clear:both"></div>
                <div style="text-align:center">
                  <br/><b>Votación 2: Paro Interno</b><br/><br/>
                </div>

                <!-- Inserte el gráfico acá. -->
                <div id="torta_2" style="text-align:center;width:400px;height:200px;"> 
                  <img id="torta_2_img" width="331" height="141"/>
                </div>
                <br />
                <table style="width:100%">
                  <tr>
                    <td style="width:1px;">
                      <img src="/graficos/graphref.php?ref=5&typ=1&dim=5&bkg=FFFFFF" width="11" height="11" /> <!-- Puntito color -->
                    </td>
                    <td style="">
                      <b>SI</b>
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="votos_2_si"></div> <!-- 781 voto(s) -->
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="porcentaje_2_si"></div> <!-- 88,75% -->
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <img src="/graficos/graphref.php?ref=11&typ=1&dim=5&bkg=FFFFFF" width="11" height="11" /> <!-- Puntito color -->
                    </td>
                    <td>
                      <b>NO</b>
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="votos_2_no"></div> <!-- 96 voto(s) -->
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="porcentaje_2_no"></div> <!-- 10,91% -->
                    </td>
                  </tr>
                  <tr>
                    <td style="width:1px;">
                      <img src="/graficos/graphref.php?ref=5&typ=1&dim=5&bkg=FFFFFF" width="11" height="11" /> <!-- Puntito color -->
                    </td>
                    <td style="">
                      <b>Definido</b>
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="votos_2_def"></div> <!-- 781 voto(s) -->
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="porcentaje_2_def"></div> <!-- 88,75% -->
                    </td>
                  </tr>
                  <tr>
                    <td style="width:1px;">
                      <img src="/graficos/graphref.php?ref=5&typ=1&dim=5&bkg=FFFFFF" width="11" height="11" /> <!-- Puntito color -->
                    </td>
                    <td style="">
                      <b>Indefinido</b>
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="votos_2_indef"></div> <!-- 781 voto(s) -->
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="porcentaje_2_indef"></div> <!-- 88,75% -->
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <img src="/graficos/graphref.php?ref=20&typ=1&dim=5&bkg=FFFFFF" width="11" height="11" /> <!-- Puntito color -->
                    </td>
                    <td>
                      <b>Blancos</b>
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="votos_2_blancos"></div> <!-- 0 voto(s) -->
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="porcentaje_2_blancos"></div> <!-- 0,00% -->
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <!-- Puntito color -->
                      <img src="/graficos/graphref.php?ref=8&typ=1&dim=5&bkg=FFFFFF" width="11" height="11" />
                    </td>
                    <td>
                      <b>Nulos</b>
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="votos_2_nulos"></div> <!-- 3 voto(s) -->
                    </td>
                    <td style="text-align:right;width:120px;">
                      <div id="porcentaje_2_nulos"></div> <!-- 0,34% -->
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
          <footer>
            <b>Creado por <a href="https://twitter.com/camilosaldias">Camilo Saldías</a>. Idea original de <a href="https://twitter.com/alexarenasf">Alex Arenas</a>. <a href="https://github.com/csaldias/node_voting">Código fuente</a>.</b>
            <b><a href="http://www.ceeinf.cl/?home">Ir a la página principal de CEEINF >></a></b>
          </footer>         
        </td>
      </tr>
    </table>
    <script>
      function drawGraph1(si, no, blancos, nulos) {
        var data = new google.visualization.arrayToDataTable([
          ['Task', 'Votacion Paro CONFECH'],
          ['Si', si],
          ['No', no],
          ['Blancos', blancos],
          ['Nulos', nulos]
        ]);
        
        new google.visualization.PieChart(document.getElementById('torta_1')).draw(data, {
          title:"La UTFSM Campus San Joaquin debe adherir al paro de la CONFECH de este Miércoles?",
          width: 400,
          height: 200,
          is3D: true
        });
      }

      function drawGraph2(si, no, blancos, nulos) {
        var data = google.visualization.arrayToDataTable([
          ['Task', 'Votacion Paro Interno'],
          ['Si', si],
          ['No', no],
          ['Blancos', blancos],
          ['Nulos', nulos]
        ]);
        
        new google.visualization.PieChart(document.getElementById('torta_2')).draw(data, {
          title:"La UTFSM debe iniciar un paro interno?",
          width: 400,
          height: 200,
          is3D: true
        });
      }

      google.setOnLoadCallback(drawGraph1);
      google.setOnLoadCallback(drawGraph2);

      var socket = io.connect('http://ec2-votaciones.csaldias.cl:8080');
      var metadata = {};

      socket.on('connect', function(){
        //Solicitamos la actualizacion inicial de valores.
        socket.emit('addstream');
      });

      function updatePercents (votes_1, votes_2) {
        var num_students = metadata['num_students'];

        var num_votes_1 = 0;
        var vote_pc_1 = 0;
        var num_votes_2 = 0;
        var vote_pc_2 = 0;
        
        for (var choice in votes_1) {
          num_votes_1 += parseInt(votes_1[choice]);
        }
        for (var choice in votes_1) {
          $('#porcentaje_1_'+choice).empty();
          vote_pc_1 = ((parseInt(votes_1[choice])*100)/num_votes_1).toFixed(2);
          $('#porcentaje_1_'+choice).append(vote_pc_1+'%');
        }
        var votes_percent_1 = ((num_votes_1*100)/num_students).toFixed(2);
        $('#votos_1_texto').empty();
        $('#votos_1_texto').append(
          'Quórum '+votes_percent_1+ '% ('
          +num_votes_1+'/'+num_students+')');
        var style = "width:"+votes_percent_1+"%;";
        if (votes_percent_1 >= metadata['quorum']) {
          style += "background:rgb(146,208,80)";
        } else {
          style += "background:red";
        }
        $('#votos_1_barra').attr('style', style);

        for (var choice in votes_2) {
          num_votes_2 += parseInt(votes_2[choice]);
        }
        for (var choice in votes_2) {
          $('#porcentaje_2_'+choice).empty();
          vote_pc_2 = ((parseInt(votes_2[choice])*100)/num_votes_2).toFixed(2);
          $('#porcentaje_2_'+choice).append(vote_pc_2+'%');
        }
        var votes_percent_2 = ((num_votes_2*100)/num_students).toFixed(2);
        $('#votos_2_texto').empty();
        $('#votos_2_texto').append(
          'Quórum '+votes_percent_2+ '% ('
          +num_votes_2+'/'+num_students+')');
        var style = "width:"+votes_percent_2+"%;";
        if (votes_percent_2 >= metadata['quorum']) {
          style += "background:rgb(146,208,80)";
        } else {
          style += "background:red";
        }
        $('#votos_2_barra').attr('style', style);
      }

      socket.on('update_counts', function (votes_1, votes_2) {
        for (var choice in votes_1) {
          $('#votos_1_'+choice).empty();
          $('#votos_1_'+choice).append(votes_1[choice] + ' voto(s)');
        }
        for (var choice in votes_2) {
          $('#votos_2_'+choice).empty();
          $('#votos_2_'+choice).append(votes_2[choice] + ' voto(s)');
        }
        updatePercents(votes_1, votes_2);
        drawGraph1(
          parseInt(votes_1['si']),
          parseInt(votes_1['no']),
          parseInt(votes_1['blanco']),
          parseInt(votes_1['nulo'])
        );
        drawGraph2(
          parseInt(votes_2['si']),
          parseInt(votes_2['no']),
          parseInt(votes_2['blancos']),
          parseInt(votes_2['nulos'])
        );
      });

      socket.on('update_status', function (msg) {
        $('#mensaje_texto').empty();
        $('#mensaje_texto').append('<b>ESTADO ACTUAL:</b> ' + msg);
      });

      socket.on('update_metadata', function (mdata) {
        metadata = mdata;
      });
    </script>
  </body>
  
</html>
